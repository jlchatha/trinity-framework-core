<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Tracking - Trinity Framework 2.0 Core Documentation</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .sidebar {
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #f1f8ff;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .nav-section {
            margin-bottom: 20px;
        }
        .nav-section-title {
            font-weight: bold;
            color: #0366d6;
            margin-bottom: 10px;
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 5px;
        }
        .nav-list {
            list-style-type: none;
            padding-left: 10px;
        }
        .nav-list li {
            margin-bottom: 8px;
        }
        .nav-list a {
            display: block;
            padding: 5px;
            border-radius: 3px;
        }
        .nav-list a:hover {
            background-color: #e1e4e8;
            text-decoration: none;
        }
        .nav-list a.active {
            background-color: #0366d6;
            color: white;
            text-decoration: none;
        }
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
        }
        .section-nav {
            background-color: #f6f8fa;
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 20px;
        }
        .section-nav a {
            margin-right: 15px;
        }
        .command-card {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 16px;
            margin: 24px 0;
            border-left: 4px solid #0366d6;
        }
        .command-card h3 {
            margin-top: 0;
            color: #0366d6;
        }
        .token-meter {
            background-color: #f6f8fa;
            border-radius: 3px;
            padding: 10px;
            margin: 20px 0;
            font-family: monospace;
        }
        .token-meter .label {
            font-weight: bold;
            color: #24292e;
        }
        .token-meter .normal {
            color: #0366d6;
        }
        .token-meter .notice {
            color: #0366d6;
        }
        .token-meter .warning {
            color: #f9c513;
        }
        .token-meter .alert {
            color: #d73a49;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="nav-section">
            <div class="nav-section-title">Getting Started</div>
            <ul class="nav-list">
                <li><a href="../index.html">Home</a></li>
                <li><a href="../quick-start.html">Quick Start Guide</a></li>
            </ul>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Reference</div>
            <ul class="nav-list">
                <li><a href="../reference/agent-roles.html">Agent Roles</a></li>
                <li><a href="../reference/protocol-files.html">Protocol Files</a></li>
                <li><a href="../reference/api-reference.html">API Reference</a></li>
                <li><a href="../reference/glossary.html">Glossary</a></li>
            </ul>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Principles</div>
            <ul class="nav-list">
                <li><a href="../principles/context-resilience.html">Context Resilience</a></li>
                <li><a href="../principles/multi-agent-collaboration.html">Multi-Agent Collaboration</a></li>
            </ul>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Guides</div>
            <ul class="nav-list">
                <li><a href="context-management.html">Context Management</a></li>
                <li><a href="aar-system.html">AAR System</a></li>
                <li><a href="workspace-organization.html">Workspace Organization</a></li>
                <li><a href="token-tracking.html" class="active">Token Tracking</a></li>
            </ul>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="metadata">
                <strong>VERSION</strong>: 1.0.0 | 
                <strong>CREATED</strong>: June 13, 2025 | 
                <strong>STATUS</strong>: Release Candidate | 
                <strong>FRAMEWORK</strong>: Trinity Framework 2.0
            </div>

            <div class="section-nav">
                <a href="../index.html">Home</a> &gt;
                <a href="#">Guides</a> &gt;
                <span>Token Tracking</span>
            </div>

            <h1>Token Tracking Guide</h1>
            
            <p>Token tracking is a core capability of the Trinity Framework 2.0, enabling agents to monitor context window utilization, create checkpoints, and maintain operational continuity across context resets. This guide explains how to implement and use the token tracking system effectively.</p>

            <div class="note">
                <p><strong>Note</strong>: While token tracking is optional in Framework 2.0, it is highly recommended for systems requiring context resilience and long-running agent operations.</p>
            </div>

            <h2>Understanding Context Windows</h2>
            
            <p>Claude and other large language models (LLMs) have a limited context window that determines how much information they can "remember" during a conversation. The Trinity Framework's token tracking system helps manage this limitation through:</p>
            
            <ul>
                <li><strong>Utilization Monitoring</strong>: Tracking how much of the context window is currently used</li>
                <li><strong>Checkpoint Creation</strong>: Saving state at key thresholds for recovery</li>
                <li><strong>Operation Estimation</strong>: Predicting how many more operations can be performed</li>
                <li><strong>Auto-Compact Detection</strong>: Detecting when context resets occur</li>
                <li><strong>Recovery Management</strong>: Restoring state after context resets</li>
            </ul>

            <h2>Token Tracking System Components</h2>
            
            <p>The Trinity Framework 2.0 token tracking system consists of several interconnected components:</p>
            
            <div class="command-card">
                <h3>Context Tracker</h3>
                <p>Monitors token usage and updates the context state file.</p>
                <pre><code>cd /tools/token-tracker/context-manager-v2/bin
./run-context-check.sh check ASSISTANT_MEDIUM</code></pre>
                <p>The tracker supports different operation types to accurately estimate token usage:</p>
                <ul>
                    <li><strong>USER_SMALL/MEDIUM/LARGE</strong>: Different sizes of user messages</li>
                    <li><strong>ASSISTANT_SMALL/MEDIUM/LARGE</strong>: Different sizes of assistant responses</li>
                    <li><strong>TOOL_READ_SMALL/MEDIUM/LARGE</strong>: Different sizes of file reads</li>
                    <li><strong>TOOL_WRITE, TOOL_EDIT, TOOL_TASK</strong>: Various tool operations</li>
                </ul>
            </div>
            
            <div class="command-card">
                <h3>Checkpoint Manager</h3>
                <p>Creates and manages state checkpoints at key utilization thresholds.</p>
                <pre><code># Checkpoints are automatically created at thresholds
# Manual checkpoint creation:
./run-context-check.sh check ASSISTANT_MEDIUM --checkpoint</code></pre>
                <p>Checkpoints contain:</p>
                <ul>
                    <li>Current utilization percentage</li>
                    <li>Timestamp of creation</li>
                    <li>Threshold status (NOTICE, WARNING, ALERT)</li>
                    <li>Recent operations history</li>
                </ul>
            </div>
            
            <div class="command-card">
                <h3>Auto-Compact Detector</h3>
                <p>Automatically detects when context resets occur and prepares recovery state.</p>
                <pre><code># Run once to check for auto-compact
./bin/recovery/auto-compact-detector.js

# Run in monitoring mode
./bin/recovery/auto-compact-detector.js --monitor</code></pre>
                <p>Detection methods include:</p>
                <ul>
                    <li>Significant drops in context utilization</li>
                    <li>Missing operation history</li>
                    <li>Time-based detection heuristics</li>
                </ul>
            </div>
            
            <div class="command-card">
                <h3>Recovery System</h3>
                <p>Handles post-compact recovery using the most recent checkpoint.</p>
                <pre><code># Check for recovery after auto-compact
./run-context-check.sh recovery</code></pre>
                <p>Recovery process:</p>
                <ul>
                    <li>Detects recovery conditions</li>
                    <li>Loads the most recent checkpoint</li>
                    <li>Restores operational awareness</li>
                    <li>Provides context metrics in recovery mode</li>
                </ul>
            </div>

            <h2>Context Visualization</h2>
            
            <p>The token tracking system provides visual feedback on context utilization through text-based meters and notifications:</p>
            
            <div class="token-meter">
                <div class="label">Normal Utilization (35%):</div>
                <div class="normal">[Context: 35% ▓▓▓▓▓▓▓░░░░░░░░░░░░░] Remaining: ~110 small operations</div>
                <br>
                <div class="label">Notice Threshold (65%):</div>
                <div class="notice">[Context: 65% ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░] NOTICE Remaining: ~60 small operations</div>
                <br>
                <div class="label">Warning Threshold (75%):</div>
                <div class="warning">[Context: 75% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░] WARNING Remaining: ~40 small operations</div>
                <br>
                <div class="label">Alert Threshold (85%):</div>
                <div class="alert">[Context: 85% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░] ALERT Remaining: ~25 small operations</div>
            </div>
            
            <p>These visualizations help users and agents understand the current context status and make informed decisions about operations.</p>

            <h2>Implementation Steps</h2>
            
            <p>To implement token tracking in your Trinity Framework 2.0 project:</p>
            
            <ol>
                <li>
                    <strong>Install Dependencies</strong>
                    <pre><code>cd /tools/token-tracker/context-manager-v2/bin/setup
./install-dependencies.sh</code></pre>
                    <p>This script sets up all necessary directories, configuration files, and symbolic links.</p>
                </li>
                <li>
                    <strong>Add Context Tracking to Protocol Files</strong>
                    <p>Update AUTO-COMPACT.md with the required directives for context tracking:</p>
                    <pre><code>## ⚠️ MANDATORY CONTEXT TRACKING - FRAMEWORK 2.0 REQUIREMENT ⚠️

Execute after EVERY response:
```bash
cd /tools/token-tracker/context-manager-v2/bin
./run-context-check.sh check ASSISTANT_MEDIUM  # Adjust type as needed
```

This is a CRITICAL FRAMEWORK 2.0 COMPLIANCE REQUIREMENT.</code></pre>
                </li>
                <li>
                    <strong>Set Up Auto-Compact Detection</strong>
                    <p>Configure auto-compact detection to run periodically:</p>
                    <pre><code># Add to startup scripts or run manually
cd /tools/token-tracker/context-manager-v2/bin
./bin/recovery/auto-compact-detector.js --monitor --interval=60</code></pre>
                </li>
                <li>
                    <strong>Update STATUS.md</strong>
                    <p>Add a Context Health section to STATUS.md to track utilization:</p>
                    <pre><code>## Context Health
- **Current Utilization**: XX% (STATUS)
- **Available Checkpoints**: N
- **Last Checkpoint**: ckpt_status_YYYYMMDD
- **Estimated Remaining Capacity**: 
  - Large operations: ~XX
  - Medium operations: ~XX
  - Small operations: ~XX</code></pre>
                </li>
                <li>
                    <strong>Test Recovery Process</strong>
                    <p>Verify that recovery works correctly after context resets:</p>
                    <pre><code># Simulate recovery after auto-compact
./run-context-check.sh recovery</code></pre>
                </li>
            </ol>
            
            <div class="warning">
                <p><strong>Warning</strong>: Consistent usage is critical for token tracking effectiveness. Always run context checks after each response to maintain accurate utilization metrics.</p>
            </div>

            <h2>Advanced Features</h2>
            
            <h3>Custom Thresholds</h3>
            <p>You can customize the threshold levels by modifying the token tracking configuration:</p>
            <pre><code>// in update-and-display.js
const THRESHOLDS = {
  NOTICE: 65,  // 65%
  WARNING: 75, // 75%
  ALERT: 85    // 85%
};</code></pre>

            <h3>Token Estimation Tuning</h3>
            <p>Adjust token estimation values for different operation types based on your specific usage patterns:</p>
            <pre><code>// in update-and-display.js
const TOKEN_ESTIMATES = {
  ASSISTANT_SMALL: 1470,  // Adjust based on observed usage
  ASSISTANT_MEDIUM: 4410,
  ASSISTANT_LARGE: 10290,
  // ...
};</code></pre>

            <h3>Reporting System</h3>
            <p>Generate detailed reports on context utilization for analysis:</p>
            <pre><code>./run-context-check.sh report text  # Text format
./run-context-check.sh report json  # JSON format</code></pre>

            <h2>Related Resources</h2>
            
            <ul>
                <li><a href="../principles/context-resilience.html">Context Resilience Principle</a></li>
                <li><a href="../reference/protocol-files.html">Protocol Files Reference</a></li>
                <li><a href="context-management.html">Context Management Guide</a></li>
            </ul>
        </div>
        
        <footer>
            <p>Trinity Framework 2.0 Core &copy; 2025 | Licensed under Apache 2.0</p>
            <p><em>Framework 2.0 COMPLIANT</em></p>
        </footer>
    </div>
</body>
</html>